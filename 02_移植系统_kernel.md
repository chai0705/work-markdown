摆脱一份幻觉比发现一个真理更能使人明智

当你在凝视深渊的时候深渊也在凝视你

前情提要：在之前的时候，简单的修改和复现了TF卡启动相关的内容，目前看起来倒是还行，现在要做的就是复现一下完整的内容，并且使用上github。

## 1.环境使用和搭建

v2ray

tabby

在tabby里面默认是没有http那些本地网络设置的，所以需要加入一些环境变量才行，具体如下所示：

~~~shell
export ftp_proxy=http://127.0.0.1:8889/
export https_proxy=http://127.0.0.1:8889/
export FTP_PROXY=http://127.0.0.1:8889/
export HTTPS_PROXY=http://127.0.0.1:8889/
export HTTP_PROXY=http://127.0.0.1:8889/
export http_proxy=http://127.0.0.1:8889/
~~~

## 2.推送

```shell
git init                                                                                                                                                                                                                                              
git add .                                                                                                                                                                                                                                             
git commit -m "first commit"                                                                                                                                                                                                                          
git branch -M main                                                                                                                                                                                                                                    
git remote add origin git@github.com:chai0705/linux-rockchip.git                                                                                                 
git push -u origin main  
```

![image-20240529143345380](https://chai-1301855619.cos.ap-beijing.myqcloud.com/image-20240529143345380.png)

## 3.编译

~~~shell
sudo dpkg-buildpackage -a "$(cat debian/arch)" -d -b -nc -uc
~~~

![image-20240529143728142](https://chai-1301855619.cos.ap-beijing.myqcloud.com/image-20240529143728142.png)

____

实际上这个命令的实际作用就是执行下面的这些步骤

~~~shell
export ARCH=arm64
/usr/bin/make rockchip_linux_defconfig \
CROSS_COMPILE=aarch64-linux-gnu- \ 
ARCH=arm64
~~~



~~~shell
/usr/bin/make -f ./Makefile \
  KERNELRELEASE=5.10.160-rockchip \
  KDEB_PKGVERSION=5.10.160-37 \
  CROSS_COMPILE=aarch64-linux-gnu- \
  ARCH=arm64 \
  -j 16
~~~

==但是我发现我运行之后并不对，可能还是有我没注意到的地方，但是上面的dpkg是没问题的,除此之外，在开发板上也是可以直接编译的，这就省了很多很多的事情==

____

最终确实是编译完成了，会得到两个包，分别为头文件包和镜像包，

![image-20240529152638984](https://chai-1301855619.cos.ap-beijing.myqcloud.com/image-20240529152638984.png)

linux-image-5.10.160-rockchip_5.10.160-37_arm64.deb 是镜像包，存放了一系列的驱动KO文件、编译好的内核镜像以及设备树的dtb和dtbo文件，具体如下所示：

![image-20240529153137853](https://chai-1301855619.cos.ap-beijing.myqcloud.com/image-20240529153137853.png)

![image-20240529153201084](https://chai-1301855619.cos.ap-beijing.myqcloud.com/image-20240529153201084.png)

linux-headers-5.10.160-rockchip_5.10.160-37_arm64.deb是头文件包, 也需要安装到系统里面。

## 4.系统分区

~~~shell
wait_loopdev() {
    local loop="$1"
    local seconds="$2"

    until test $((seconds--)) -eq 0 -o -b "${loop}"; do sleep 1; done

    ((++seconds))

    ls -l "${loop}" &> /dev/null
}


disk="/dev/sdc"

# Ensure disk is not mounted
mount_point=tmp
sudo mkdir -p ${mount_point}


# Setup partition table
sudo dd if=/dev/zero of="${disk}" count=4096 bs=512
sudo parted --script "${disk}" \
	mklabel gpt \
	mkpart primary ext4 16MiB 100%

# Create partitions
{
        echo "t"
        echo "1"
        echo "C12A7328-F81F-11D2-BA4B-00A0C93EC93B"
        echo "w"
} | sudo fdisk "${disk}" &> /dev/null || true

sudo partprobe "${disk}"

partition_char="$(if [[ ${disk: -1} == [0-9] ]]; then echo p; fi)"

sleep 1

wait_loopdev "${disk}${partition_char}1" 60 || {
        echo "Failure to create ${disk}${partition_char}1 in time"
        exit 1
}

sleep 1

# Generate random uuid for rootfs
root_uuid=$(uuidgen)

# Create filesystems on partitions
sudo dd if=/dev/zero of="${disk}1" bs=1KB count=10 > /dev/null
sudo mkfs.ext4 -U "${root_uuid}" -L desktop-rootfs "${disk}1"

# Mount partitions
sudo mkdir -p ${mount_point}/writable
sudo mount "${disk}1" ${mount_point}/writable

sudo umount "${disk}1"
~~~

## 5.创建extlinux

~~~shell
## /boot/extlinux/extlinux.conf
##
## IMPORTANT WARNING
##
## The configuration of this file is generated automatically.
## Do not edit this file manually, use: u-boot-update

default l0
menu title U-Boot menu
prompt 1
timeout 20


label l0
        menu label EMMC
        linux /boot/vmlinuz-5.10.160-rockchip
        initrd /boot/initrd.img
        fdt /usr/lib/linux-image-5.10.160-rockchip/rockchip/topeet-rk3588-linux.dtb

        append root=/dev/mmcblk0p1 rootwait rw console=ttyS2,115200 console=tty1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memoryquiet splash plymouth.ignore-serial-consoles


label l0r
        menu label TF
        linux /boot/vmlinuz-5.10.160-rockchip
        initrd /boot/initrd.img
        fdt /usr/lib/linux-image-5.10.160-rockchip/rockchip/topeet-rk3588-linux.dtb
        append root=/dev/mmcblk1p1 rootwait rw console=ttyS2,115200 console=tty1 cgroup_enable=cpuset cgrroup_memory=1 cgroup_enable=memoryquiet splash plymouth.ignore-serial-consoles

~~~

这里还要拷贝一下initrd.img才行

## 6.上电运行

进入uboot之后这里要有个选择，这里用的是TF卡，所以选择2：
![image-20240529171145068](https://chai-1301855619.cos.ap-beijing.myqcloud.com/image-20240529171145068.png)

进入系统之后如下所示：

![image-20240529171042668](https://chai-1301855619.cos.ap-beijing.myqcloud.com/image-20240529171042668.png)



